using System;
using System.Collections.Generic;
using System.Text;
using System.IO;
using System.Net;


namespace travianlogin
{
    class Program
    {
        static void Main(string[] args)
        {

            travianCommunication.login();
            Console.ReadKey();
        }
    }

    public class TravianCommunication
    {
        public TravianCommunication()
        {
          ...
        }

        // This method requests the home page content for the specified server.
        public string getData(string page)
        {

            String result;
           
            HttpWebRequest httpRequest = (HttpWebRequest)WebRequest.Create(page);

            // Set credentials to use for this request.
           
            httpRequest.CookieContainer = new CookieContainer();
            httpRequest.Credentials = CredentialCache.DefaultCredentials;
            HttpWebResponse response = (HttpWebResponse)httpRequest.GetResponse();

            // Get the stream associated with the response.
            Stream receiveStream = response.GetResponseStream();

            // Pipes the stream to a higher level stream reader with the required
            StreamReader readStream = new StreamReader(receiveStream, Encoding.UTF8);

            result = readStream.ReadToEnd();
           
            Console.Write("Response stream received.");
            Console.Write(result);

            readStream.Close();

            return result;
        }

        public void postData(string post_url, string poststring)
        {
            HttpWebRequest httpRequest = (HttpWebRequest)WebRequest.Create(post_url);
            httpRequest = (HttpWebRequest)WebRequest.Create(post_url + "?" + poststring);

            // Set credentials to use for this request.
            httpRequest.CookieContainer = new CookieContainer();
            HttpWebResponse response = (HttpWebResponse)httpRequest.GetResponse();

            // Get the stream associated with the response.
            Stream receiveStream = response.GetResponseStream();

            // Pipes the stream to a higher level stream reader with the required
            StreamReader readStream = new StreamReader(receiveStream, Encoding.UTF8);

            Console.Write("Response stream received.");
            Console.Write(readStream.ReadToEnd());

            readStream.Close();
        }

        public void login()
        {
            string loginPage = this.getData("http://s2.travian.cz/login.php");
            Console.WriteLine("\n\n *** Login Page *** \n\n" + loginPage);

            //
            string tempString;
            tempString = loginPage.Substring(loginPage.IndexOf("type=\"hidden\" name=\"login\""), 50);
            String hiddenLogin = tempString.Substring(tempString.IndexOf("value") + 7, tempString.IndexOf("\">") - tempString.IndexOf("value") - 7);
            // gets a random name value
            tempString = loginPage.Substring(loginPage.IndexOf("class=\"fm fm110\" type=\"text\" name=\""), 50);
            String randomName = tempString.Substring(tempString.IndexOf("name=") + 6, tempString.IndexOf("\" value") - tempString.IndexOf("name=") - 6);
            // gets a random pass value
            tempString = loginPage.Substring(loginPage.IndexOf("class=\"fm fm110\" type=\"password\""), 60);
            String randomPass = tempString.Substring(tempString.IndexOf("name=") + 6, tempString.IndexOf("\" value") - tempString.IndexOf("name=") - 6);
            // gets a "random hidden" attribute value
            tempString = loginPage.Substring(loginPage.IndexOf("<p align=\"center\"><input type=\"hidden\" name=\""), 60);
            String randomHidden = tempString.Substring(tempString.IndexOf("name=") + 6, tempString.IndexOf("\" value") - tempString.IndexOf("name=") - 6);
            // generates POST data
            String postData = "'w=1024%3A1024&login=" + hiddenLogin + "&" + randomName + "=" + username + "&" + randomPass + "=" + password + "&" + randomHidden + "=1451c95544&s1.x=45&s1.y=6&s1=login&autologin=ja'\n\n";

            this.postData("http://s2.travian.cz/dorf1.php", postData);
         }
    }
}